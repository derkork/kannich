#!/bin/sh
# Kannich Wrapper Script
# Runs Kannich inside Docker - no local JVM required.
# Commit this file with your project to enable portable CI builds.

set -e

# Configuration
KANNICH_IMAGE="${KANNICH_IMAGE:-derkork/kannich:latest}"
KANNICH_CACHE_DIR="${KANNICH_CACHE_DIR:-$HOME/.kannich/cache}"
DEFAULT_ENV_PREFIXES="CI_ GITHUB_ BUILD_ CIRCLE_ TRAVIS_ BITBUCKET_ KANNICH_"

# Determine project directory
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="${PROJECT_DIR:-$SCRIPT_DIR}"

# Detect --dev-mode / -d flag
DEV_MODE=0
for arg in "$@"; do
    case "$arg" in
        --dev-mode|-d) DEV_MODE=1; break ;;
    esac
done

# Check for Docker
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: Docker not found. Please install Docker." >&2
    exit 1
fi

if ! docker info >/dev/null 2>&1; then
    echo "Error: Docker daemon not running. Please start Docker." >&2
    exit 1
fi

# Ensure cache directory exists
if [ ! -d "$KANNICH_CACHE_DIR" ]; then
    echo "Creating cache directory: $KANNICH_CACHE_DIR"
    mkdir -p "$KANNICH_CACHE_DIR" || {
        echo "Error: Failed to create cache directory: $KANNICH_CACHE_DIR" >&2
        exit 1
    }
fi

# Pull image if not present
if ! docker image inspect "$KANNICH_IMAGE" >/dev/null 2>&1; then
    echo "Pulling Kannich builder image..."
    docker pull "$KANNICH_IMAGE"
fi

# Container name for cleanup
CONTAINER_NAME="kannich-$$"

# Read environment variable prefixes from .kannichenv or use defaults
ENV_PREFIXES=""
if [ -f "$PROJECT_DIR/.kannichenv" ]; then
    while IFS= read -r line || [ -n "$line" ]; do
        # Strip comments and whitespace
        line="${line%%#*}"
        case "$line" in
            *[!\ ]*) ENV_PREFIXES="$ENV_PREFIXES $line" ;;
        esac
    done < "$PROJECT_DIR/.kannichenv"
else
    ENV_PREFIXES="$DEFAULT_ENV_PREFIXES"
fi

# Build environment variable arguments for docker
ENV_ARGS=""
for prefix in $ENV_PREFIXES; do
    for var in $(env | grep "^$prefix" | cut -d= -f1); do
        ENV_ARGS="$ENV_ARGS -e $var"
    done
done

# Always forward all DOCKER_* environment variables
for var in $(env | grep "^DOCKER_" | cut -d= -f1); do
    ENV_ARGS="$ENV_ARGS -e $var"
done

# Determine Docker socket mount
DOCKER_SOCKET_MOUNT=""
if [ -n "$DOCKER_HOST" ]; then
    case "$DOCKER_HOST" in
        unix://*)
            DOCKER_SOCKET_PATH="${DOCKER_HOST#unix://}"
            DOCKER_SOCKET_MOUNT="-v $DOCKER_SOCKET_PATH:$DOCKER_SOCKET_PATH"
            ;;
        tcp://*) ;;  # No socket mount needed
        *) DOCKER_SOCKET_MOUNT="-v /var/run/docker.sock:/var/run/docker.sock" ;;
    esac
else
    DOCKER_SOCKET_MOUNT="-v /var/run/docker.sock:/var/run/docker.sock"
fi

# Mount DOCKER_CERT_PATH if set
DOCKER_CERT_MOUNT=""
if [ -n "$DOCKER_CERT_PATH" ]; then
    DOCKER_CERT_MOUNT="-v $DOCKER_CERT_PATH:$DOCKER_CERT_PATH"
fi

# Resolve tcp:// hostname to IP for container use
DOCKER_HOST_ENV=""
if [ -n "$DOCKER_HOST" ]; then
    case "$DOCKER_HOST" in
        tcp://*)
            TCP_HOST_PORT="${DOCKER_HOST#tcp://}"
            TCP_HOST="${TCP_HOST_PORT%%:*}"
            TCP_PORT="${TCP_HOST_PORT##*:}"

            # Resolve hostname to IP
            RESOLVED_IP=""
            if command -v getent >/dev/null 2>&1; then
                RESOLVED_IP=$(getent hosts "$TCP_HOST" 2>/dev/null | awk '{print $1; exit}')
            fi
            if [ -z "$RESOLVED_IP" ]; then
                RESOLVED_IP=$(ping -c 1 "$TCP_HOST" 2>/dev/null | grep -oE '\([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\)' | head -1 | tr -d '()')
            fi

            if [ -n "$RESOLVED_IP" ]; then
                DOCKER_HOST_ENV="-e DOCKER_HOST=tcp://$RESOLVED_IP:$TCP_PORT"
            fi
            ;;
    esac
fi

# Cleanup function
cleanup() {
    docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
}
trap cleanup EXIT INT TERM

# Dev mode: mount host .m2/repository
DEV_MODE_MOUNT=""
if [ "$DEV_MODE" -eq 1 ]; then
    HOST_M2_REPO="$HOME/.m2/repository"
    if [ ! -d "$HOST_M2_REPO" ]; then
        echo "Error: Dev mode requires ~/.m2/repository to exist." >&2
        echo "Run 'mkdir -p ~/.m2/repository' or 'mvn install' on a project first."
        exit 1
    fi
    DEV_MODE_MOUNT="-v $HOST_M2_REPO:/kannich/dev-repo"
fi

# Run Kannich inside Docker
# shellcheck disable=SC2086
docker run --rm \
    --init \
    --name "$CONTAINER_NAME" \
    --privileged \
    -v "$PROJECT_DIR:/workspace" \
    -v "$KANNICH_CACHE_DIR:/kannich/cache" \
    $DOCKER_SOCKET_MOUNT \
    $DOCKER_CERT_MOUNT \
    $DEV_MODE_MOUNT \
    $ENV_ARGS \
    $DOCKER_HOST_ENV \
    -w /workspace \
    "$KANNICH_IMAGE" \
    /kannich/jdk/bin/java -jar /kannich/kannich-cli.jar "$@"
